<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotate Media - Cred Issue Reporter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700;800&family=IBM+Plex+Sans:wght@200;300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="annotate.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <h1>Cred Issue Reporter - Annotate & Submit</h1>
      <div class="header-actions">
        <div class="draft-dropdown">
          <button id="saveDraftBtn" class="icon-btn" title="Save Draft">
            üíæ <span class="draft-status-indicator"></span>
          </button>
          <div id="draftDropdownMenu" class="dropdown-menu hidden">
            <button id="saveDraftNow" class="dropdown-item">Save Draft</button>
            <button id="saveDraftAs" class="dropdown-item">Save Draft As...</button>
            <div class="dropdown-divider"></div>
            <button id="loadDraft" class="dropdown-item">Load Draft...</button>
            <button id="deleteDraft" class="dropdown-item">Delete Current Draft</button>
          </div>
        </div>
        <button id="helpBtn" class="icon-btn" title="Help & User Guide">
          ‚ùì Help
        </button>
        <button id="settingsBtn" class="icon-btn" title="Settings">
          ‚öôÔ∏è Settings
        </button>
        <button id="closeTab" class="icon-btn" title="Close">
          ‚úï Close
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent">
      <!-- Step 1: Annotate Screenshot -->
      <section id="annotateSection" class="section active">
        <div class="section-header">
          <h2>1. Annotate Screenshot</h2>
          <button id="continueToReport" class="btn btn-primary">
            Continue to Report ‚Üí
          </button>
        </div>

        <!-- Tool Options Bar (Photoshop-style top bar) -->
        <div class="tool-options-bar">
          <div class="options-group">
            <label for="colorPickerTop">Color</label>
            <input type="color" id="colorPickerTop" value="#ff0000">
          </div>
          <div class="options-group">
            <label for="lineWidthTop">Width</label>
            <select id="lineWidthTop" class="width-selector">
              <option value="1">1px</option>
              <option value="2">2px</option>
              <option value="3" selected>3px</option>
              <option value="4">4px</option>
              <option value="5">5px</option>
              <option value="6">6px</option>
              <option value="8">8px</option>
              <option value="10">10px</option>
            </select>
          </div>
          <div class="options-divider"></div>
          <button id="undoBtnTop" class="options-btn" title="Undo (Ctrl+Z)">‚Ü∂ Undo</button>
          <button id="redoBtnTop" class="options-btn" title="Redo (Ctrl+Y)">‚Ü∑ Redo</button>
          <div class="options-divider"></div>
          <button id="clearAnnotationsTop" class="options-btn options-btn-danger" title="Clear All">üóëÔ∏è Clear</button>
          <div id="cropControlsTop" style="display: none;">
            <div class="options-divider" style="display: inline-block; vertical-align: middle;"></div>
            <button id="applyCropTop" class="options-btn options-btn-primary">‚úì Apply</button>
            <button id="cancelCropTop" class="options-btn">‚úï Cancel</button>
          </div>
          <div class="options-divider"></div>
          <!-- Zoom Controls -->
          <div class="options-group zoom-options">
            <button id="zoomOutBtn" class="options-btn" title="Zoom Out (Ctrl+-)">‚àí</button>
            <span id="zoomLevel" class="zoom-level-display">100%</span>
            <button id="zoomInBtn" class="options-btn" title="Zoom In (Ctrl++)">+</button>
            <button id="zoomResetBtn" class="options-btn" title="Reset Zoom (Ctrl+0)">‚ü≤</button>
          </div>
        </div>

        <div class="content-wrapper">
          <!-- Vertical Toolbar (Photoshop-style left sidebar) -->
          <div class="vertical-toolbar">
            <div class="vtool-group">
              <button class="vtool-btn" data-tool="arrow" title="Arrow (A)">
                <span class="vtool-icon">‚ûú</span><span class="vtool-key">A</span>
              </button>
              <button class="vtool-btn" data-tool="rectangle" title="Rectangle (R)">
                <span class="vtool-icon">‚ñ≠</span><span class="vtool-key">R</span>
              </button>
              <button class="vtool-btn" data-tool="circle" title="Circle (C)">
                <span class="vtool-icon">‚≠ï</span><span class="vtool-key">C</span>
              </button>
              <button class="vtool-btn active" data-tool="pen" title="Pen (P)">
                <span class="vtool-icon">‚úèÔ∏è</span><span class="vtool-key">P</span>
              </button>
              <button class="vtool-btn" data-tool="text" title="Text (T)">
                <span class="vtool-icon">T</span><span class="vtool-key">T</span>
              </button>
              <button class="vtool-btn" data-tool="blackout" title="Redact (X)">
                <span class="vtool-icon">‚¨õ</span><span class="vtool-key">X</span>
              </button>
            </div>
            <div class="vtool-divider"></div>
            <div class="vtool-group">
              <button class="vtool-btn" data-tool="move" title="Move (V)">
                <span class="vtool-icon">‚úã</span><span class="vtool-key">V</span>
              </button>
              <button class="vtool-btn" data-tool="crop" title="Crop (K)">
                <span class="vtool-icon">‚úÇÔ∏è</span><span class="vtool-key">K</span>
              </button>
            </div>
            <div class="vtool-divider"></div>
            <div class="vtool-group">
              <button class="vtool-btn" data-tool="pan" title="Pan (hold Space)">
                <span class="vtool-icon">üëÜ</span>
              </button>
            </div>
          </div>

          <!-- Main canvas area -->
          <div class="canvas-area">
            <div class="canvas-container">
              <canvas id="annotationCanvas"></canvas>
            </div>
          </div>

          <!-- Media Strip (Photoshop-style right sidebar) -->
          <div class="media-strip">
            <div class="media-strip-header">
              <span id="mediaCount">0 items</span>
            </div>
            <div class="media-thumbnails" id="screenshotsList">
              <!-- Dynamically generated thumbnails -->
            </div>
            <div class="media-strip-actions">
              <button id="captureAnotherBtn" class="media-action-btn" title="Screenshot (üì∏)">üì∏</button>
              <button id="recordVideoBtn" class="media-action-btn" title="Record Video (üé•)">üé•</button>
            </div>
          </div>
        </div>

        <!-- Annotation Footer with keyboard hints -->
        <div class="annotation-footer">
          <div class="keyboard-hints">
            <span class="hint"><kbd>A</kbd>=Arrow</span>
            <span class="hint"><kbd>R</kbd>=Rect</span>
            <span class="hint"><kbd>C</kbd>=Circle</span>
            <span class="hint"><kbd>P</kbd>=Pen</span>
            <span class="hint"><kbd>T</kbd>=Text</span>
            <span class="hint"><kbd>X</kbd>=Redact</span>
            <span class="hint"><kbd>V</kbd>=Move</span>
            <span class="hint"><kbd>K</kbd>=Crop</span>
          </div>
          <div class="footer-actions">
            <button id="continueToReportFooter" class="btn btn-primary">Continue ‚Üí</button>
          </div>
        </div>
      </section>

      <!-- Step 2: Fill Issue Report -->
      <section id="reportSection" class="section hidden">
        <div class="section-header">
          <h2>2. Issue Details</h2>
          <div class="header-actions">
            <button id="backToAnnotate" class="btn btn-secondary">
              ‚Üê Back to Annotations
            </button>
            <button type="submit" form="bugReportForm" id="submitBtn" class="btn btn-primary">
              <span class="btn-text">Submit Issue Report</span>
              <span class="spinner hidden"></span>
            </button>
          </div>
        </div>

        <div class="report-wrapper">
          <div class="form-container">
            <form id="bugReportForm">
              <!-- Issue Mode Toggle -->
              <div class="mode-toggle" style="margin-bottom: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
                <label style="font-weight: 600; margin-bottom: 12px; display: block; color: #333;">Report Mode</label>
                <div style="display: flex; gap: 24px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="issueMode" id="issueModeCreate" value="create" checked>
                    <span>Create New Issue</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="issueMode" id="issueModeUpdate" value="update">
                    <span>Add to Existing Issue</span>
                  </label>
                </div>
              </div>

              <!-- Existing Issue Section (hidden by default) -->
              <div id="existingIssueSection" class="hidden" style="margin-bottom: 24px; padding: 16px; background: #e3f2fd; border-radius: 8px;">
                <div class="form-group">
                  <label for="issueSearchInput">Search Issue by Number or Subject</label>
                  <input type="text" id="issueSearchInput" placeholder="Enter issue # (e.g., 1234) or search by subject">
                  <small style="display: block; margin-top: 4px; color: #666;">
                    Type an issue number or keywords to search
                  </small>
                </div>

                <div class="form-group" style="margin-top: 12px;">
                  <label for="projectFilterSelect">Filter by Project (Optional)</label>
                  <select id="projectFilterSelect">
                    <option value="">-- All Projects --</option>
                  </select>
                  <small style="display: block; margin-top: 4px; color: #666;">
                    Select a project to filter recent issues
                  </small>
                </div>

                <div class="form-group" style="margin-top: 12px;">
                  <label for="issueSelect">Or Select from Recent Issues</label>
                  <select id="issueSelect">
                    <option value="">-- Select Issue --</option>
                  </select>
                  <button type="button" id="loadIssuesBtn" class="btn btn-secondary btn-small" style="margin-top: 8px;">
                    Load Recent Issues
                  </button>
                </div>

                <div id="selectedIssuePreview" class="hidden" style="margin-top: 16px; padding: 12px; background: #fff; border: 1px solid #2196F3; border-radius: 4px;">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                      <h4 id="selectedIssueTitle" style="margin: 0 0 8px 0; color: #333;"></h4>
                      <p id="selectedIssueDetails" style="margin: 0; font-size: 12px; color: #666;"></p>
                    </div>
                    <button type="button" id="clearIssueSelection" class="btn btn-secondary btn-small">Clear</button>
                  </div>
                </div>

                <div id="issueSearchStatus" class="status-message" style="margin-top: 8px;"></div>
              </div>

              <!-- Note Field (shown only in update mode) -->
              <div id="noteFieldSection" class="hidden" style="margin-bottom: 24px;">
                <div class="form-group full-width">
                  <label for="noteText">Note / Comment *</label>
                  <textarea id="noteText" rows="5" placeholder="Add a note or comment to the issue..."></textarea>
                  <small style="display: block; margin-top: 4px; color: #666;">
                    This comment will be added to the selected issue along with attachments
                  </small>
                </div>
              </div>

              <div class="form-grid" id="createIssueFields">
                <div class="form-group">
                  <label for="project">Project *</label>
                  <select id="project" required>
                    <option value="">-- Select Project --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="tracker">Tracker *</label>
                  <select id="tracker" required>
                    <option value="">-- Select Tracker --</option>
                  </select>
                </div>

                <div class="form-group full-width">
                  <label for="subject">Subject *</label>
                  <input type="text" id="subject" placeholder="Brief description of the issue" required>
                </div>

                <div class="form-group full-width">
                  <label for="description">Description</label>
                  <textarea id="description" rows="5" placeholder="Detailed description of the bug"></textarea>
                </div>

                <div class="form-group">
                  <label for="priority">Priority *</label>
                  <select id="priority" required>
                    <option value="">-- Select Priority --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="assignee">Assignee *</label>
                  <select id="assignee" required>
                    <option value="">-- Select Assignee --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="dueDate">Due Date *</label>
                  <input type="date" id="dueDate" required>
                </div>

                <div class="form-group">
                  <label for="category">Category</label>
                  <select id="category">
                    <option value="">-- No Category --</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="version">Target Version</label>
                  <select id="version">
                    <option value="">-- No Version --</option>
                  </select>
                </div>

                <div class="form-group full-width">
                  <label for="stepsToReproduce">Steps to Reproduce</label>
                  <textarea id="stepsToReproduce" rows="4" placeholder="1. Go to...&#10;2. Click on...&#10;3. Observe..."></textarea>
                </div>

                <div class="form-group full-width">
                  <label for="expectedBehavior">Expected Behavior</label>
                  <textarea id="expectedBehavior" rows="3" placeholder="What should happen?"></textarea>
                </div>

                <div class="form-group full-width">
                  <label for="actualBehavior">Actual Behavior</label>
                  <textarea id="actualBehavior" rows="3" placeholder="What actually happened?"></textarea>
                </div>
              </div>

              <!-- Common Fields (visible in both create and update modes) -->
              <div class="form-grid" id="commonFields">
                <div class="form-group full-width checkbox-group">
                  <label>
                    <input type="checkbox" id="attachTechnicalData" checked>
                    <span>Attach technical data (page info, network requests, console logs)</span>
                  </label>
                </div>

                <!-- Tab Selector for Multi-Tab Capture -->
                <div class="form-group full-width" id="tabSelectorGroup">
                  <label>
                    <input type="checkbox" id="captureFromOtherTabs">
                    <span>Capture HAR & console logs from other tabs</span>
                  </label>
                  <div id="tabSelectorContainer" class="tab-selector hidden" style="margin-top: 10px; margin-left: 24px;">
                    <p class="tab-selector-hint" style="font-size: 12px; color: #666; margin-bottom: 8px;">
                      Select tabs to include network requests and console logs:
                    </p>
                    <div id="tabList" class="tab-list"></div>
                    <div id="tabSelectorStatus" class="status-message" style="margin-top: 8px; font-size: 11px;"></div>
                  </div>
                </div>

                <div class="form-group full-width">
                  <label for="additionalDocuments">Additional Documents</label>
                  <input type="file" id="additionalDocuments" multiple
                         accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.zip,.log,.json,.xml,.csv,.xls,.xlsx">
                  <small style="display: block; margin-top: 4px; color: #666;">
                    Upload additional files (PDFs, documents, images, logs, etc.)
                  </small>
                  <div id="selectedFilesList" class="selected-files-list"></div>
                </div>
              </div>

              <div id="submitStatus" class="status-message"></div>
            </form>
          </div>

          <div class="preview-container">
            <h3>Media Preview</h3>
            <div id="screenshotPreviewContainer" class="screenshot-preview-container">
              <!-- Screenshots will be dynamically added here -->
            </div>
          </div>
        </div>
      </section>

      <!-- Success Section -->
      <section id="successSection" class="section hidden">
        <div class="success-container">
          <div class="success-icon">‚úì</div>
          <h2>Issue Submitted!</h2>
          <p>Your issue has been successfully submitted to Redmine.</p>
          <div id="issueLink"></div>
          <div class="button-group">
            <button id="closeAfterSuccess" class="btn btn-primary">
              Close Tab
            </button>
          </div>
        </div>
      </section>

      <!-- Loading Section -->
      <section id="loadingSection" class="section hidden">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <h2>Loading Screenshot...</h2>
          <p>Please wait while we prepare your screenshot for annotation.</p>
        </div>
      </section>

      <!-- Error Section -->
      <section id="errorSection" class="section hidden">
        <div class="error-container">
          <div class="error-icon">‚ö†Ô∏è</div>
          <h2>Error</h2>
          <p id="errorMessage">An error occurred while loading the screenshot.</p>
          <button id="closeAfterError" class="btn btn-primary">
            Close Tab
          </button>
        </div>
      </section>
    </main>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal hidden">
      <div class="modal-overlay" id="modalOverlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h2>Review & Edit Before Submission</h2>
          <button id="closeReviewModal" class="icon-btn">‚úï</button>
        </div>

        <div class="modal-body">
          <p class="review-description">Review and edit all information below. All changes will be included in the submission to Redmine.</p>

          <!-- Tab Navigation -->
          <div class="tab-nav">
            <button class="tab-btn active" data-tab="formData">Issue Details</button>
            <button class="tab-btn" data-tab="media">Media</button>
            <button class="tab-btn" data-tab="pageInfo">Page Info</button>
            <button class="tab-btn" data-tab="network">Network (<span id="networkCount">0</span>)</button>
            <button class="tab-btn" data-tab="console">Console (<span id="consoleCount">0</span>)</button>
            <button class="tab-btn" data-tab="documents">Documents (<span id="documentsCount">0</span>)</button>
          </div>

          <!-- Tab Content -->
          <div class="tab-content">
            <!-- Issue Details Tab -->
            <div id="formDataTab" class="tab-pane active">
              <div class="review-section">
                <p class="review-description" style="margin-bottom: 16px; color: #4CAF50;">‚úèÔ∏è You can edit any field below before submitting</p>
                <div class="review-item">
                  <label for="reviewProjectSelect">Project: *</label>
                  <select id="reviewProjectSelect" class="review-select" required></select>
                </div>
                <div class="review-item">
                  <label for="reviewTrackerSelect">Issue Type: *</label>
                  <select id="reviewTrackerSelect" class="review-select" required></select>
                </div>
                <div class="review-item">
                  <label for="reviewSubjectInput">Title: *</label>
                  <input type="text" id="reviewSubjectInput" class="review-input" required placeholder="Enter issue title">
                </div>
                <div class="review-item">
                  <label for="reviewPrioritySelect">Priority: *</label>
                  <select id="reviewPrioritySelect" class="review-select" required></select>
                </div>
                <div class="review-item">
                  <label for="reviewAssigneeSelect">Assignee: *</label>
                  <select id="reviewAssigneeSelect" class="review-select" required>
                    <option value="">-- Select Assignee --</option>
                  </select>
                </div>
                <div class="review-item">
                  <label for="reviewDueDateInput">Due Date: *</label>
                  <input type="date" id="reviewDueDateInput" class="review-input" required>
                </div>
                <div class="review-item full-width">
                  <label for="reviewDescriptionText">Description: *</label>
                  <textarea id="reviewDescriptionText" class="review-textarea" rows="10" required placeholder="Enter description"></textarea>
                </div>
              </div>
            </div>

            <!-- Media Tab (Screenshots and Videos) -->
            <div id="mediaTab" class="tab-pane">
              <div class="review-section">
                <!-- Content will be dynamically populated with screenshots and videos -->
              </div>
            </div>

            <!-- Page Info Tab -->
            <div id="pageInfoTab" class="tab-pane">
              <div class="review-section">
                <pre id="reviewPageInfo" class="code-block"></pre>
              </div>
            </div>

            <!-- Network Tab -->
            <div id="networkTab" class="tab-pane">
              <div class="review-section">
                <p class="tab-info"><span id="networkCountText">0</span> network requests captured</p>
                <p class="tab-info" style="color: #4CAF50; font-size: 12px;">üìé Will be attached as HAR file (network-requests-*.har)</p>
                <div id="reviewNetwork" class="data-list"></div>
              </div>
            </div>

            <!-- Console Tab -->
            <div id="consoleTab" class="tab-pane">
              <div class="review-section">
                <p class="tab-info"><span id="consoleCountText">0</span> console logs captured</p>
                <p class="tab-info" style="color: #4CAF50; font-size: 12px;">üìé Will be attached as text file (console-logs-*.txt)</p>
                <div id="reviewConsole" class="data-list"></div>
              </div>
            </div>

            <!-- Additional Documents Tab -->
            <div id="documentsTab" class="tab-pane">
              <div class="review-section">
                <p class="tab-info"><span id="documentsCountText">0</span> additional document(s) selected</p>
                <p class="tab-info" style="color: #4CAF50; font-size: 12px;">üìé Will be attached with original filenames</p>
                <div id="reviewDocuments" class="data-list"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button id="cancelSubmit" class="btn btn-secondary">Cancel</button>
          <button id="confirmSubmit" class="btn btn-primary">
            <span class="btn-text">Confirm & Submit</span>
            <span class="spinner hidden"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Draft Recovery Modal -->
  <div id="draftRecoveryModal" class="modal hidden">
    <div class="modal-overlay" id="draftRecoveryOverlay"></div>
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>Unsaved Draft Found</h2>
        <button id="closeDraftRecoveryModal" class="icon-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="draft-recovery-message">You have an unsaved draft:</p>
        <div id="draftRecoveryInfo" class="draft-info-card">
          <h4 id="draftRecoveryName"></h4>
          <p id="draftRecoveryDetails"></p>
        </div>
        <p class="draft-recovery-hint">Would you like to continue editing this draft or start fresh?</p>
      </div>
      <div class="modal-footer">
        <button id="draftStartFresh" class="btn btn-secondary">Start Fresh</button>
        <button id="draftViewAll" class="btn btn-secondary">View All Drafts</button>
        <button id="draftContinue" class="btn btn-primary">Continue Editing</button>
      </div>
    </div>
  </div>

  <!-- Draft Manager Modal -->
  <div id="draftManagerModal" class="modal hidden">
    <div class="modal-overlay" id="draftManagerOverlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>Saved Drafts</h2>
        <button id="closeDraftManagerModal" class="icon-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="draftsList" class="drafts-list">
          <!-- Drafts will be dynamically populated here -->
        </div>
        <div id="noDraftsMessage" class="no-drafts-message hidden">
          <p>No saved drafts found.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button id="clearAllDrafts" class="btn btn-danger">Clear All Drafts</button>
        <button id="closeDraftManager" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Unsaved Changes Warning Modal -->
  <div id="unsavedChangesModal" class="modal hidden">
    <div class="modal-overlay" id="unsavedChangesOverlay"></div>
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>Unsaved Changes</h2>
        <button id="closeUnsavedChangesModal" class="icon-btn">‚úï</button>
      </div>
      <div class="modal-body">
        <p>You have unsaved changes. Would you like to save them as a draft before leaving?</p>
      </div>
      <div class="modal-footer">
        <button id="discardChanges" class="btn btn-danger">Discard</button>
        <button id="cancelClose" class="btn btn-secondary">Cancel</button>
        <button id="saveAndClose" class="btn btn-primary">Save Draft & Close</button>
      </div>
    </div>
  </div>

  <script src="../lib/utils.js"></script>
  <script src="../lib/redmine-api.js"></script>
  <script src="../lib/video-storage.js"></script>
  <script src="../lib/draft-storage.js"></script>
  <script src="../lib/screenshot-storage.js"></script>
  <script src="../content/annotator.js"></script>
  <script src="annotate.js"></script>
</body>
</html>
