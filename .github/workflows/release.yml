name: Automated Release Workflow

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  # =============================================================================
  # STAGE 1: PREPARE
  # Environment setup and version detection
  # =============================================================================
  prepare:
    name: "Stage 1: Prepare"
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read

    outputs:
      version_type: ${{ steps.version_type.outputs.type }}

    steps:
      - name: Detect version bump type
        id: version_type
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "Labels: $LABELS"

          if echo "$LABELS" | grep -q "version:major"; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "Detected: MAJOR version bump"
          elif echo "$LABELS" | grep -q "version:minor"; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "Detected: MINOR version bump"
          else
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "Detected: PATCH version bump (default)"
          fi

      - name: Stage Summary
        run: |
          echo "## Stage 1: Prepare" >> $GITHUB_STEP_SUMMARY
          echo "- Version bump type: **${{ steps.version_type.outputs.type }}**" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # STAGE 2: BUILD
  # Version bump, changelog generation, and extension build
  # =============================================================================
  build:
    name: "Stage 2: Build"
    needs: prepare
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      version: ${{ steps.bump_version.outputs.version }}
      zip_file: ${{ steps.build.outputs.zip_file }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Bump version
        id: bump_version
        run: |
          node .github/scripts/bump-version.js ${{ needs.prepare.outputs.version_type }}
          NEW_VERSION=$(node -p "require('./manifest.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update CHANGELOG
        run: |
          node .github/scripts/generate-changelog.js \
            "${{ steps.bump_version.outputs.version }}" \
            "${{ github.event.pull_request.title }}" \
            "${{ github.event.pull_request.body }}" \
            "${{ github.event.pull_request.number }}" \
            "${{ github.event.pull_request.user.login }}"

      - name: Build extension zip
        id: build
        run: |
          node .github/scripts/build-extension.js
          ZIP_FILE="Cap-screen-v${{ steps.bump_version.outputs.version }}.zip"
          echo "zip_file=$ZIP_FILE" >> $GITHUB_OUTPUT
          echo "Built: $ZIP_FILE"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            manifest.json
            CHANGELOG.md
            Cap-screen-v${{ steps.bump_version.outputs.version }}.zip
          retention-days: 1

      - name: Stage Summary
        run: |
          echo "## Stage 2: Build" >> $GITHUB_STEP_SUMMARY
          echo "- New version: **v${{ steps.bump_version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Extension ZIP: \`${{ steps.build.outputs.zip_file }}\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # STAGE 3: DISTRIBUTE
  # Upload to external services (Google Drive and Redmine)
  # =============================================================================
  distribute:
    name: "Stage 3: Distribute"
    needs: build
    runs-on: ubuntu-latest

    outputs:
      drive_link: ${{ steps.upload_drive.outputs.drive_link }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Upload to Google Drive
        id: upload_drive
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          DEBUG: 'true'
        run: |
          echo "=== Debug Info ==="
          echo "Folder ID length: ${#GOOGLE_DRIVE_FOLDER_ID}"
          echo "Credentials length: ${#GOOGLE_DRIVE_CREDENTIALS}"
          echo "==================="
          node .github/scripts/upload-to-drive.js \
            "${{ needs.build.outputs.zip_file }}" \
            "${{ needs.build.outputs.version }}"
          DRIVE_LINK=$(cat drive-link.txt)
          echo "drive_link=$DRIVE_LINK" >> $GITHUB_OUTPUT
          echo "Google Drive link: $DRIVE_LINK"

      - name: Create Redmine news
        env:
          REDMINE_API_KEY: ${{ secrets.REDMINE_API_KEY }}
          REDMINE_SERVER_URL: ${{ secrets.REDMINE_SERVER_URL }}
          REDMINE_PROJECT_ID: ${{ secrets.REDMINE_PROJECT_ID }}
        run: |
          node .github/scripts/create-redmine-news.js \
            "${{ needs.build.outputs.version }}" \
            "${{ steps.upload_drive.outputs.drive_link }}"

      - name: Stage Summary
        run: |
          echo "## Stage 3: Distribute" >> $GITHUB_STEP_SUMMARY
          echo "- Google Drive: [${{ steps.upload_drive.outputs.drive_link }}](${{ steps.upload_drive.outputs.drive_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- Redmine news: Created" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # STAGE 4: PUBLISH
  # Commit changes and create GitHub release
  # =============================================================================
  publish:
    name: "Stage 4: Publish"
    needs: [prepare, build, distribute]
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Commit version changes
        run: |
          git add manifest.json CHANGELOG.md ${{ needs.build.outputs.zip_file }}
          git commit -m "chore: release v${{ needs.build.outputs.version }} [skip ci]

          Auto-generated by release workflow
          PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"

          git push origin main --force-with-lease

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "Release v${{ needs.build.outputs.version }}"
          body: |
            ## Cred Issue Reporter v${{ needs.build.outputs.version }}

            ### Changes
            ${{ github.event.pull_request.title }}

            ${{ github.event.pull_request.body }}

            ### Downloads
            - [Chrome Extension ZIP](${{ needs.distribute.outputs.drive_link }})
            - [View on Redmine](${{ secrets.REDMINE_SERVER_URL }}/projects/${{ secrets.REDMINE_PROJECT_ID }}/news)

            ---
            Merged PR #${{ github.event.pull_request.number }} by @${{ github.event.pull_request.user.login }}
          files: |
            ${{ needs.build.outputs.zip_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final Summary
        run: |
          echo "## Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ needs.prepare.outputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Extension ZIP: \`${{ needs.build.outputs.zip_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Google Drive: [${{ needs.distribute.outputs.drive_link }}](${{ needs.distribute.outputs.drive_link }})" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release: [v${{ needs.build.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updates" >> $GITHUB_STEP_SUMMARY
          echo "- manifest.json version bumped" >> $GITHUB_STEP_SUMMARY
          echo "- CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          echo "- Extension built and uploaded to Google Drive" >> $GITHUB_STEP_SUMMARY
          echo "- Redmine news created" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub release created" >> $GITHUB_STEP_SUMMARY
          echo "- Changes committed to main branch" >> $GITHUB_STEP_SUMMARY
